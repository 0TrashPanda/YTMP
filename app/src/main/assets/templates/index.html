<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/static/images/icons/speaker2.png">
    <link rel="stylesheet" href="/static/css/output.css">
    <title>YTMC</title>
</head>
<body>
    <div class="overflow-x-auto scrollbar-hide lg:overflow-visible flex flex-row xl:space-x-4 space-x-0 2xl:container xl:mx-auto snap-x snap-mandatory">

        <div id="search" class="relative pb-12 lg:pb-2 p-2 flex-none w-screen lg:w-auto lg:flex-1 h-screen overflow-y-auto snap-center snap-always">
            <div class="sticky top-0 z-50 w-full max-w-96 my-3 mx-auto bg-[rgba(100,100,100,.95)] rounded-lg flex flex-col cursor-pointer">
                <div class="flex justify-between">
                    <img id="search_img" hx-post="/search" hx-target="#song-container" hx-include="[name='search_query']" class="w-16 h-10 px-4 py-2" src="{{ url_for('static',filename='images/icons/loupe.png') }}" alt="search" onclick="hideSuggestions()">
                    <input id="search_input" hx-post="/search" hx-target="#song-container" hx-trigger="keyup[key=='Enter']" class="w-full p-2 bg-transparent focus:outline-none" name="search_query" type="text" oninput="showSuggestions(this.value)" onfocusout="hideSuggestions()" placeholder="Search for songs" onfocus="showSuggestions(this.value)">
                    <img class="w-16 h-10 px-4 py-2" src="{{ url_for('static',filename='images/icons/clear.png') }}" alt="clear" onclick="clearThisID('search_input')">
                </div>
                <div id="suggestions-container" class="bg-primary w-full absolute top-full left-0 z-10 border border-gray-300 rounded-lg hidden">
                    <!-- Suggestions will be dynamically inserted here -->
                </div>
            </div>
            <div id="song-container" class="">
            </div>
        </div>

        <div id="player" class="pb-12 lg:pb-2 p-2 flex-none w-screen lg:w-auto lg:flex-1 h-screen overflow-y-auto snap-center snap-always text-center">
            <!-- Song Thumbnail -->
            <img id="song_thumbnail" class="max-h-[50vh] mb-6 mx-auto rounded-lg shadow-lg object-cover" src="https://via.placeholder.com/300" alt="Song Thumbnail">

            <!-- Song Details -->
            <div class="mb-6">
                <h2 id="current_song_title" class="text-xl font-bold">Song Title</h2>
                <p id="current_song_artist" class="text-sm text-gray-400">Artist 1, Artist 2</p>
                <p id="current_song_album" class="text-sm text-gray-400">Album Name</p>
                <p id="current_song_year" class="text-sm text-gray-400">2024</p>
            </div>

            <!-- Controls -->
            <div class="flex justify-between items-center mb-6">
                <button id="prev" hx-post="/back" hx-swap="none" class="w-10 h-10">
                    <img src="https://img.icons8.com/ios-filled/50/ffffff/skip-to-start.png" alt="Previous">
                </button>
                <button id="playPause" hx-post="/play_pause" hx-swap="none" class="w-14 h-14">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class=""><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>
                </button>
                <button id="next" hx-post="/skip" hx-swap="none" class="w-10 h-10">
                    <img src="https://img.icons8.com/ios-filled/50/ffffff/end.png" alt="Next">
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="bg-gray-700 h-2 rounded-full relative">
                <div id="progressBar" class="bg-green-500 h-full rounded-full" style="width: 50%;"></div>
            </div>
            <input type="range" min="1" max="100" value="50" class="slider m-6 bg-gray-700" id="volume" oninput="setVolume(this.value)">
        </div>

        <div id="queues" class="relative pb-12 overflow-clip lg:pb-2 p-2 flex-none w-screen lg:w-auto lg:flex-1 h-screen overflow-y-auto snap-center snap-always">
            <h2 class="sticky top-0 z-50 px-4 py-3 flex items-center font-semibold text-sm bg-[rgba(15,15,15,.97)]">Queue</h2>
            <div id="queue" class="pb-6 flex flex-col">
            </div>
            <h2 class="sticky top-0 z-50 px-4 py-3 flex items-center font-semibold text-sm bg-[rgba(15,15,15,.97)]">Radio Queue</h2>
            <div id="radio_queue" class="flex flex-col">
            </div>
        </div>

    <!-- Bottom navigation bar for small screens -->
    <div class="lg:hidden h-12 fixed bottom-0 w-full bg-[rgba(15,15,15,.97)] text-white flex justify-around">
        <button id="nav_search" onclick="scrollToPanel('search')" class="focus:outline-none"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="nav_icon"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg></button>
        <button id="nav_player" onclick="scrollToPanel('player')" class="focus:outline-none"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="nav_icon"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 0 1 0 .656l-5.603 3.113a.375.375 0 0 1-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112Z" /></svg></button>
        <button id="nav_queues" onclick="scrollToPanel('queues')" class="focus:outline-none"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="nav_icon"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg></button>
    </div>

    <div id="alerts" class="w-full mb-16 absolute bottom-0 ">
    </div>

</body>
<script type="text/javascript" src="{{ url_for('static',filename='js/suggestions.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static',filename='js/more_options.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static',filename='js/nav.js') }}"></script>
<script type="text/javascript">
    var updateInteval;
    var length = 0
    let startTime;
    let elapsedTime = 0;
    let progress_bar = document.querySelector('#progressBar');
    let progress_bar_container = progress_bar.parentElement;
    let isDragging = false;
    let current_song_uuid = null;
    var song_dict = {};
    mobile = window.matchMedia("(max-width: 1024px)")
    is_mobile = mobile.matches;
    let sortableInstance = null;
    const queueList = document.getElementById('queue');
    const radio_queue_list = document.getElementById('radio_queue');


    function clearThisID(target) {
        document.getElementById(target).value = "";
    }

    var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on('connect', function() {
        console.log('Connected to WebSocket server');
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from WebSocket server');
    });

    socket.on('search_suggestions', function(data) {
        processSearchSugestions(data);
    });

    socket.on('update_queue', function(data) {
        var queue = document.querySelector('#queue'); // Get the song container element
        var radio_queue = document.querySelector('#radio_queue');
        queue.innerHTML = "";
        radio_queue.innerHTML = "";
        song_dict = {};
        for (song of data.queue) {
            queue.innerHTML += createQueueItem(song);
            song_dict[song.uuid] = song;
        }
        for (song of data.radio_queue) {
            radio_queue.innerHTML += createQueueItem(song);
            song_dict[song.uuid] = song;
        }
        HighlightCurrentSong(current_song_uuid);
        setTimeout(function() {
            scrollSearchToTop();
        }, 1000);
        htmx.process(queues);
    });

    socket.on('play_state', function(data) {
        var play_button = document.querySelector('#playPause'); // Get the song container element
        if (data == 'Playing') {
            startTime = Date.now() - elapsedTime;
            if (updateInteval) clearInterval(updateInteval);
            updateInteval = setInterval(function () {
                elapsedTime = Date.now() - startTime;
                updateProgressBar();
            }, 50);
            play_button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class=""><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>'
        } else if (data = 'Paused') {
            clearInterval(updateInteval);
            play_button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class=""><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" /></svg>'
        }
    });

    socket.on('current_song', function(data) {
        var song_thumbnail = document.querySelector('#song_thumbnail');
        song_thumbnail.src = data.thumbnail;
        var current_song_title = document.querySelector('#current_song_title');
        current_song_title.innerHTML = data.title;
        var current_song_artist = document.querySelector('#current_song_artist');
        current_song_artist.innerHTML = data.artists;
        var current_song_album = document.querySelector('#current_song_album');
        current_song_album.innerHTML = data.album;
        var current_song_year = document.querySelector('#current_song_year');
        current_song_year.innerHTML = data.release_year;
        length = data.duration_sec - 1;
        updateProgressBar();
        scrollToCurrentSong(data.uuid);
        HighlightCurrentSong(data.uuid);
        current_song_uuid = data.uuid;
        setBackgroundGradient(data.thumbnail);
    });

    function setBackgroundGradient(url) {
        const colorThief = new ColorThief();
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.src = url;
        img.onload = function () {
            const colors = colorThief.getPalette(img, 2); // Get the dominant colors
            document.querySelector('body').style.background =
                `linear-gradient(to bottom right, rgba(${colors[0]}, 1), rgba(${colors[1]}, 1))`;
        }
    }

    socket.on('alert', function(data) {
        var alerts = document.querySelector('#alerts');
        var alertDiv = document.createElement('div');
        alertDiv.className = 'alert bg-primary text-white p-2 rounded-lg m-2';
        alertDiv.textContent = data;
        alerts.appendChild(alertDiv);
        setTimeout(function() {
            alerts.removeChild(alertDiv);
        }, 1500);
    });

    function HighlightCurrentSong(uuid) {
        var queue = document.querySelector('#queue');
        var queue_items = queue.children;
        for (item of queue_items) {
            if (item.querySelector('#uuid').value == uuid) {
                item.style.backgroundColor = 'rgba(255,255,255,.1)';
            } else {
                item.style.backgroundColor = 'transparent';
            }
        }
    }

    function scrollToCurrentSong(uuid) {
        var queue = document.querySelector('#queue');
        var queue_items = queue.children;
        for (let item of queue_items) {
            if (item.querySelector('#uuid').value == uuid) {
                // Get the position of the item relative to the top of the queue
                var itemTop = item.offsetTop;

                // Calculate the scroll position for vertical centering
                var scrollPosition = itemTop - (queue.clientHeight / 2) + (item.offsetHeight / 2);

                // Smoothly scroll the queue container only on the y-axis
                queue.scrollTo({
                    top: scrollPosition,
                    behavior: 'smooth'
                });
                return;
            }
        }
    }

    socket.on('volume', function(data) {
        var volume = document.querySelector('#volume');
        volume.value = data;
    });

    socket.on('current_time', function(data) {
        startTime = Date.now() - data;
        elapsedTime = data;
        updateProgressBar();
    });

    function scrollSearchToTop() {
        var search = document.querySelector('#search');
        search.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function createQueueItem(song) {
        return `
        <div id="queue_item" class="song lg:cursor-move ripple-container p-2 border-b-[1px] h-20 flex items-center border-[rgba(255,255,255,.1)]" draggable="true" oncontextmenu="more_options(event, ${song.uuid}, 'queue')">
            <!-- <img class="mr-4 ml-2 sm:ml-0 h-12 w-12 min-w-12 md:min-w-[60px] md:h-[60px]" src="${song.thumbnail}" alt="${song.title}"> -->
            <div hx-post="/jump_queue" hx-include="next input" hx-swap="none" class="relative mr-4 size-12 min-w-[48px] md:min-w-[60px] md:h-[60px] md:w-[60px] cursor-pointer">
                <img class="thumbnail object-cover transition duration-300" src="${song.thumbnail}" alt="${song.title}" loading="lazy">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon size-8 absolute inset-0 m-auto text-white opacity-0 transition-opacity duration-300">
                    <path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="flex flex-wrap flex-col">
                <p class="mb-1 text-ellipsis whitespace-nowrap overflow-hidden w-full">${song.title}</p>
                <div class="flex text-[#b4b4b4]">
                    <p class="text-xs text-dark">${song.artists}</p>
                    <span class="text-xs text-dark whitespace-pre"> • </span>
                    <p class="text-xs text-dark">${song.duration_str}</p>
                </div>
            </div>
            <div class="ml-auto relative">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden lg:block options-icon size-6 cursor-pointer" onclick="more_options(event, ${song.uuid}, 'queue')">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="p-2 move_icon block lg:hidden size-10 cursor-pointer">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5" />
                </svg>
            </div>
            <input id="uuid" type="hidden" name="uuid" value="${song.uuid}">
        </div>`;
    }

    function changeHandler() {
        handleSelector = window.innerWidth >= 1024 ? '#queue_item' : '.move_icon';
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        // Create a new Sortable instance
        sortableInstance = new Sortable(queueList, {
            animation: 150,
            handle: handleSelector,
            ghostClass: 'ghost',
            group: 'queue',
            onEnd: function (evt) {
                const uuidList = {
                    'queue': Array.from(queueList.children).map(child => child.querySelector('#uuid') ? child.querySelector('#uuid').value : ''),
                    'radio_queue': Array.from(radio_queue_list.children).map(child => child.querySelector('#uuid') ? child.querySelector('#uuid').value : '')
                }
                socket.emit('reorder', uuidList);
            }
        });
        // Create a new Sortable instance
        sortableInstance = new Sortable(radio_queue_list, {
            animation: 150,
            handle: handleSelector,
            ghostClass: 'ghost',
            group: 'queue',
            onEnd: function (evt) {
                const uuidList = {
                    'queue': Array.from(queueList.children).map(child => child.querySelector('#uuid') ? child.querySelector('#uuid').value : ''),
                    'radio_queue': Array.from(radio_queue_list.children).map(child => child.querySelector('#uuid') ? child.querySelector('#uuid').value : '')
                }
                socket.emit('reorder', uuidList);
            }
        });
    }

    changeHandler();

    // Reinitialize on resize
    window.addEventListener('resize', function() {
        if (mobile.matches != is_mobile) {
            is_mobile = mobile.matches;
            changeHandler();
        }
    });

    function updateProgressBar() {
        if (isDragging) return;
        procent = Math.min(elapsedTime / (length * 10), 100);
        progress_bar.style.width = procent + '%';
    }

    function setVolume(val) {
        socket.emit('volume', val);
    }

    function updatePosition(event) {
        if (!isDragging) return;
        const containerRect = progress_bar_container.getBoundingClientRect();
        let horizontalPosition = ((event.clientX - containerRect.left) / containerRect.width) * 100;
        horizontalPosition = Math.max(0, Math.min(100, horizontalPosition));
        progress_bar.style.width = `${horizontalPosition}%`;
        socket.emit('seek', horizontalPosition / 100);
    }

    function startDragging(event) {
        isDragging = true;
        updatePosition(event);
    }

    function stopDragging() {
        isDragging = false;
    }

    progress_bar_container.addEventListener('mousedown', startDragging);
    document.addEventListener('mousemove', updatePosition);
    document.addEventListener('mouseup', stopDragging);
    progress_bar.addEventListener('dragstart', function (event) {
        event.preventDefault();
    });
    progress_bar_container.addEventListener('mousedown', function (event) {
        event.preventDefault();
    });

    scrollToPanel('player');
</script>
</html>
